<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Settlement Training</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  :root {
    --color-bg: #ffffff;
    --color-primary: #111827;
    --color-accent: #2563eb;
    --color-accent-dark: #1d4ed8;
    --color-text: #6b7280;
    --color-card-bg: #f9fafb;
    --color-card-shadow: rgba(0,0,0,0.1);
    --border-radius: 0.75rem;
    --transition-fast: 0.2s ease-in-out;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0; padding: 0;
    font-family: 'Inter', Arial, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  header {
    position: sticky;
    top: 0;
    background: var(--color-bg);
    box-shadow: 0 1px 4px var(--color-card-shadow);
    padding: 1rem 2rem;
    font-weight: 700;
    font-size: 2.5rem;
    color: var(--color-primary);
    text-align: center;
    z-index: 100;
  }

  main {
    max-width: 900px;
    margin: 3rem auto 5rem;
    padding: 0 1.5rem;
  }

  #homeScreen, #questionPopup, #quizArea, #summary, #difficultySelectOverlay, #categorySelectOverlay, #manageQueriesOverlay {
    background: var(--color-card-bg);
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px var(--color-card-shadow);
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
  }

  #homeScreen {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  button {
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: 600;
    transition: background var(--transition-fast);
    width: 100%;
    max-width: 240px;
  }

  button:hover,
  button:focus {
    background: var(--color-accent-dark);
    outline: none;
  }

  label {
    display: block;
    margin: 1rem 0 0.3rem;
    font-weight: 600;
    color: var(--color-primary);
    font-size: 0.95rem;
  }

  select, input[type=text], input[type=datetime-local], textarea {
    width: 100%;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    color: var(--color-primary);
    background: white;
    transition: border-color var(--transition-fast);
  }

  select:focus,
  input[type=text]:focus,
  input[type=datetime-local]:focus,
  textarea:focus {
    border-color: var(--color-accent);
    outline: none;
    box-shadow: 0 0 5px var(--color-accent);
  }

  textarea {
    resize: vertical;
    min-height: 3.5rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    margin: 0.3rem 0;
    font-weight: 400;
    color: var(--color-primary);
    cursor: pointer;
  }

  .checkbox-label input {
    margin-right: 0.5rem;
    cursor: pointer;
  }

  /* Layout adjustments */

  #quizQuestionArea {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #questionMain {
    flex: 1 1 100%;
    display: flex;
    flex-direction: row;
    gap: 1rem;
    align-items: center;
    min-width: 280px;
    color: var(--color-primary);
    font-weight: 600;
    font-size: 1.1rem;
  }

  #questionDate {
    font-size: 0.9rem;
    color: var(--color-text);
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
    line-height: 1.2;
    align-self: center;
  }

  #quizQuestion {
    flex-grow: 1;
    white-space: normal;
    overflow-wrap: break-word;
    line-height: 1.3;
    display: flex;
    align-items: center;
  }

  #questionDescription {
    font-size: 0.9rem;
    margin-top: 0.6rem;
    color: var(--color-text);
    white-space: normal;
    overflow-wrap: break-word;
    flex-basis: 100%;
  }

  #quizInputArea {
    margin-top: 1rem;
  }

  #quizInputControls {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  #submitAndSideDescContainer {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 0.4rem;
    flex-wrap: wrap;
  }

  #questionSideDescription {
    font-size: 0.9rem;
    color: var(--color-primary);
    font-style: italic;
    max-width: 320px;
    max-height: 100px;
    overflow-y: auto;
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
  }

  #timer {
    font-weight: 700;
    font-size: 1.05rem;
    margin-bottom: 1rem;
    color: var(--color-accent);
  }

  #feedback {
    font-weight: 700;
    margin-top: 1rem;
    min-height: 1.5rem;
    color: var(--color-accent-dark);
  }

  /* Overlays */

  #difficultySelectOverlay, #categorySelectOverlay, #manageQueriesOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1100;
    padding: 1rem;
  }

  #difficultySelectOverlay > div, #categorySelectOverlay > div, #manageQueriesOverlay > div {
    background: var(--color-bg);
    padding: 2rem 2.5rem;
    border-radius: var(--border-radius);
    max-width: 360px;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    max-height: 80vh;
    overflow-y: auto;
    color: var(--color-primary);
  }

  #difficultySelectOverlay label, #categorySelectOverlay label, #manageQueriesOverlay label {
    font-weight: 500;
    margin: 1rem 0 0.3rem;
    font-size: 1rem;
    cursor: pointer;
    display: block;
    color: var(--color-primary);
  }

  #difficultySelectOverlay input[type=radio],
  #categorySelectOverlay input[type=radio] {
    margin-right: 0.5rem;
    cursor: pointer;
  }

  #questionPopup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 650px;
    width: 90%;
    background: var(--color-card-bg);
    padding: 2rem 2.5rem;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 15px var(--color-card-shadow);
    z-index: 1200;
    overflow-y: auto;
    max-height: 90vh;
  }

  #popupOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 1150;
  }

  #manageFilterArea {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.7rem;
    align-items: center;
  }

  #manageFilterArea select {
    flex: 1;
    font-size: 1rem;
  }

  #manageQueriesList {
    text-align: left;
    max-height: 50vh;
    overflow-y: auto;
    margin-bottom: 1rem;
  }

  .query-item {
    border-bottom: 1px solid #e5e7eb;
    padding: 0.5rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .query-question {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .query-date {
    font-size: 0.8rem;
    color: var(--color-text);
    margin-left: 0.5rem;
    white-space: nowrap;
  }

  .remove-query-btn {
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 0.4rem;
    cursor: pointer;
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    transition: background var(--transition-fast);
  }

  .remove-query-btn:hover {
    background: #b91c1c;
  }

  button.edit-btn {
    background: #2563eb;
    font-weight: 700;
    color: #fff;
    border-radius: 0.5rem;
    padding: 0.3rem 0.8rem;
    margin-left: 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    border: none;
    flex-shrink: 0;
    transition: background var(--transition-fast);
  }

  button.edit-btn:hover {
    background: #1e40af;
  }

  /* Summary */

  #summary h3 {
    margin-top: 0;
    color: var(--color-primary);
  }

  #incorrectList {
    text-align: left;
    margin-top: 1rem;
  }

  .incorrect-item {
    background: #fee2e2;
    border: 1px solid #b91c1c;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    color: var(--color-primary);
  }

  .incorrect-question {
    font-weight: 700;
    margin-bottom: 0.4rem;
    color: #991b1b;
  }

  .incorrect-user-answer {
    margin-left: 0.5rem;
    font-style: italic;
    color: var(--color-text);
  }

  .incorrect-correct-answer {
    margin-left: 0.5rem;
    font-weight: 600;
    color: #15803d;
  }

  .timedout-question {
    margin-left: 0.5rem;
    font-style: italic;
    color: #b45309;
    font-weight: 600;
  }

  /* Responsive adjustments */

  @media (max-width: 480px) {
    #questionMain {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4rem;
    }
    #submitAndSideDescContainer {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.7rem;
    }
    #questionSideDescription {
      max-width: 100%;
      max-height: initial;
      padding-top: 0.3rem;
      margin-left: 0;
    }
    button {
      width: 100%;
      max-width: none;
    }
    #manageFilterArea {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>
</head>
<body>

<header>Settlement Training</header>

<main>
  <div id="homeScreen" aria-label="Home screen with main menu">
    <button onclick="showQuestionPopup()" aria-haspopup="dialog" aria-controls="questionPopup" type="button">Add Queries</button>
    <button onclick="showCategorySelector()" aria-haspopup="dialog" aria-controls="categorySelectOverlay" type="button">Start Quiz</button>
    <button onclick="showManageQueries()" aria-haspopup="dialog" aria-controls="manageQueriesOverlay" type="button">Manage Queries</button>
  </div>

  <div id="popupOverlay" onclick="closeQuestionPopup()" role="presentation" tabindex="-1" aria-hidden="true"></div>

  <!-- Add Query Popup -->
  <div id="questionPopup" role="dialog" aria-modal="true" aria-labelledby="popupTitle" tabindex="-1">
    <h3 id="popupTitle">Add Settlement Query</h3>
    <label for="newDateTime">Date &amp; Time:</label>
    <input type="datetime-local" id="newDateTime" />

    <label for="newQuestion">Settlement Query:</label>
    <input type="text" id="newQuestion" placeholder="Enter your query here..." />

    <label for="newDescription">Description:</label>
    <textarea id="newDescription" rows="3" placeholder="Additional details..."></textarea>

    <label for="newSideDescription">Optional Side Description:</label>
    <textarea id="newSideDescription" rows="2" placeholder="Optional description to show on quiz right side..."></textarea>

    <label for="categorySelect">Category:</label>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <select id="categorySelect" style="flex: 1;"></select>
      <button type="button" id="addCategoryBtn" aria-label="Add new category" style="background:#15803d; font-weight:700; color:#fff; border-radius:0.5rem; padding: 0.4rem 0.75rem; cursor: pointer;">+</button>
    </div>
    <div id="newCategoryInputArea" style="display:none; margin-top:0.5rem; gap: 0.5rem; align-items: center;">
      <input type="text" id="newCategoryInput" placeholder="Enter new category" style="flex: 1; padding: 0.4rem 1rem; font-size: 1rem;" aria-label="New category name"/>
      <button type="button" id="confirmNewCategoryBtn" style="background:#166534; font-weight:700; color:#fff; border-radius:0.5rem; padding: 0.4rem 1rem; cursor:pointer;">Add</button>
      <button type="button" id="cancelNewCategoryBtn" style="background:#b91c1c; font-weight:700; color:#fff; border-radius:0.5rem; padding: 0.4rem 1rem; cursor:pointer;">Cancel</button>
    </div>

    <label for="questionType">Query Type:</label>
    <select id="questionType" onchange="showOptionFields()" aria-label="Select query type">
      <option value="open">Open Ended</option>
      <option value="yesno">Tick Box (Yes / No)</option>
      <option value="multiple">Multiple Choice (tick one)</option>
    </select>

    <div id="openAnswer" style="display:block; margin-top:1rem;">
      <label for="newAnswerOpen">Correct Answer:</label>
      <input type="text" id="newAnswerOpen" placeholder="Correct answer text" />
    </div>

    <div id="yesNoAnswer" style="display:none; margin-top:1rem;">
      <label>Correct Answer:</label>
      <label class="checkbox-label">
        <input type="checkbox" name="yesnoAdd" value="Yes" /> Yes
      </label>
      <label class="checkbox-label">
        <input type="checkbox" name="yesnoAdd" value="No" /> No
      </label>
    </div>

    <div id="multipleOptions" style="display:none; margin-top:1rem;">
      <label>Options (enter at least 2):</label>
      <input type="text" class="option-input" placeholder="Option 1" />
      <input type="text" class="option-input" placeholder="Option 2" />
      <input type="text" class="option-input" placeholder="Option 3 (optional)" />
      <input type="text" class="option-input" placeholder="Option 4 (optional)" />

      <label for="newAnswer" style="margin-top:0.5rem;">Correct Answer (must match one option):</label>
      <input type="text" id="newAnswer" placeholder="Correct answer" />
    </div>

    <div style="margin-top: 1.5rem; display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 0.75rem;">
      <button id="addUpdateQuestionBtn" onclick="addQuestion()" type="button">Add Query</button>
      <button onclick="closeQuestionPopup()" type="button" style="background:#b91c1c; margin-left: 0.5rem;">Cancel</button>
    </div>
  </div>

  <!-- Category Selector Overlay -->
  <div id="categorySelectOverlay" role="dialog" aria-modal="true" aria-labelledby="categorySelectTitle" tabindex="-1">
    <div>
      <h3 id="categorySelectTitle">Select Category</h3>
      <label for="quizCategorySelect">Choose category:</label>
      <select id="quizCategorySelect" style="width: 100%; padding: 0.5rem; font-size: 1rem; margin-bottom: 1rem;">
        <!-- options dynamically populated -->
      </select>
      <button onclick="showDifficultySelector()" type="button" style="margin-top:1rem;">Next: Select Difficulty</button>
      <button onclick="closeCategorySelector()" type="button" style="margin-top:0.75rem; background:#b91c1c;">Cancel</button>
    </div>
  </div>

  <!-- Difficulty Selector Overlay -->
  <div id="difficultySelectOverlay" role="dialog" aria-modal="true" aria-labelledby="difficultySelectTitle" tabindex="-1">
    <div>
      <h3 id="difficultySelectTitle">Select Difficulty &amp; Number of Queries</h3>
      <label for="quizDifficultySelect">Choose difficulty:</label>
      <select id="quizDifficultySelect" style="width: 100%; padding: 0.5rem; font-size: 1rem; margin-bottom: 1rem;">
        <option value="easy">Easy (2 min per query)</option>
        <option value="medium">Medium (1 min per query)</option>
        <option value="hard">Hard (30 sec per query)</option>
        <option value="insane">Insane (15 sec per query)</option>
        <option value="peaceful">Peaceful (No time limit)</option>
      </select>

      <label for="queryCountSelect">Number of Queries:</label>
      <select id="queryCountSelect" style="width: 100%; padding: 0.5rem; font-size: 1rem; margin-bottom: 1rem;">
        <option value="10">10 Queries</option>
        <option value="20">20 Queries</option>
        <option value="30">30 Queries</option>
        <option value="40">40 Queries</option>
        <option value="50">50 Queries</option>
        <option value="60">60 Queries</option>
      </select>

      <button onclick="startQuiz()" type="button" style="margin-top:1rem;">Start</button>
      <button onclick="closeDifficultySelector()" type="button" style="margin-top:0.75rem; background:#b91c1c;">Cancel</button>
    </div>
  </div>

  <!-- Manage Queries Overlay -->
  <div id="manageQueriesOverlay" role="dialog" aria-modal="true" aria-labelledby="manageQueriesTitle" tabindex="-1">
    <div>
      <h3 id="manageQueriesTitle">Manage Queries</h3>
      <div id="manageFilterArea">
        <select id="manageCategoryFilter" onchange="filterManageQueries()" aria-label="Filter queries by category">
          <!-- dynamically populated -->
        </select>
        <button style="background:#b91c1c; color:#fff; font-weight:600; border:none; border-radius:0.5rem; padding:0.4rem 1rem; cursor:pointer;" onclick="removeSelectedCategory()" title="Remove selected category if empty" type="button">Remove Category</button>
      </div>
      <div id="manageQueriesList" tabindex="0" aria-live="polite" aria-relevant="additions removals">
      </div>
      <label class="checkbox-label" style="margin-top: 0.5rem;">
        <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)" /> Select All
      </label>
      <button onclick="removeSelectedQueries()" style="margin-top:1rem; background:#b91c1c; color:#fff; font-weight:600; border:none; border-radius:0.5rem; padding:0.6rem 1.5rem; cursor:pointer;" type="button">Remove Selected Queries</button>
      <button onclick="closeManageQueries()" style="margin-top:1rem; background:#b91c1c; color:#fff; font-weight:600; border:none; border-radius:0.5rem; padding:0.6rem 1.5rem; cursor:pointer;" type="button">Close</button>
    </div>
  </div>

  <div id="quizArea" style="display:none;" aria-live="polite" aria-relevant="text">
    <div id="timer" role="timer" aria-live="assertive"></div>
    <div id="quizQuestionArea">
      <div id="questionMain">
        <div id="questionDate"></div>
        <div id="quizQuestion"></div>
      </div>
      <div id="questionDescription"></div>
    </div>
    <div id="quizInputArea">
      <div id="quizInputControls"></div>
    </div>
    <div id="feedback" aria-live="polite"></div>
  </div>

  <div id="summary" style="display:none;" aria-live="polite"></div>
</main>

<!-- SheetJS library for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // Data and state
  let questions = [];
  let filteredQuestions = [];
  let categories = [];
  let timerInterval;
  let timeLeft = 0;
  let currentIndex = 0;
  let correctAnswers = 0;
  let timedOutCount = 0;
  let answeredCount = 0;
  let chosenDifficulty = 'easy';
  let chosenCategory = 'All Categories';
  let chosenNumQueries = 10;

  let userResponses = [];
  let startTime;
  let totalTimeTaken = 0;

  // Your server API endpoint - adjust as needed
  const API_ENDPOINT = 'http://localhost:3000/questions';

  const difficultyTimes = {
    easy: 120,
    medium: 60,
    hard: 30,
    insane: 15,
    peaceful: null
  };

  loadQuestionsFromStorage();

  function initCategories() {
    const catSet = new Set();
    questions.forEach(q => {
      if(q.category && q.category.trim() !== '') {
        catSet.add(q.category.trim());
      }
    });
    categories = Array.from(catSet).sort();
    if(categories.length === 0) {
      categories.push('Uncategorized');
    }
    populateCategorySelect();
    populateManageCategoryFilter();
  }

  function populateCategorySelect() {
    const select = document.getElementById('categorySelect');
    select.innerHTML = '';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
    if(!select.value && categories.length) {
      select.value = categories[0];
    }
    hideNewCategoryInputArea();
  }

  function populateManageCategoryFilter() {
    const filter = document.getElementById('manageCategoryFilter');
    filter.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'All Categories';
    optAll.textContent = 'All Categories';
    filter.appendChild(optAll);
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      filter.appendChild(option);
    });
    filter.value = 'All Categories';
  }

  // Populate dropdown in categorySelectOverlay
  function populateCategoryOptions() {
    const select = document.getElementById('quizCategorySelect');
    select.innerHTML = '';

    const optAll = document.createElement('option');
    optAll.value = 'All Categories';
    optAll.textContent = 'All Categories';
    select.appendChild(optAll);

    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
    select.value = 'All Categories';
  }

  function filterManageQueries() {
    renderManageQueriesList();
  }

  function showNewCategoryInputArea() {
    document.getElementById('newCategoryInputArea').style.display = 'flex';
    document.getElementById('categorySelect').style.display = 'none';
    document.getElementById('addCategoryBtn').style.display = 'inline-block';
    document.getElementById('newCategoryInput').value = '';
    document.getElementById('newCategoryInput').focus();
  }

  function hideNewCategoryInputArea() {
    document.getElementById('newCategoryInputArea').style.display = 'none';
    document.getElementById('categorySelect').style.display = 'block';
    document.getElementById('addCategoryBtn').style.display = 'inline-block';
  }

  function showQuestionPopup() {
    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('questionPopup').style.display = 'block';
    resetAddQueryFields();
    initCategories();
    clearEditMode();
    document.getElementById('questionPopup').focus();
  }

  function closeQuestionPopup() {
    document.getElementById('popupOverlay').style.display = 'none';
    document.getElementById('questionPopup').style.display = 'none';
    clearEditMode();
  }

  function resetAddQueryFields() {
    document.getElementById('newDateTime').value = '';
    document.getElementById('newQuestion').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newSideDescription').value = '';
    document.getElementById('questionType').value = 'open';
    showOptionFields();
    document.getElementById('newAnswerOpen').value = '';
    document.getElementById('newAnswer').value = '';
    hideNewCategoryInputArea();
    const yesNoBoxes = document.getElementsByName('yesnoAdd');
    for (let i = 0; i < yesNoBoxes.length; i++) {
      yesNoBoxes[i].checked = false;
    }
    let opts = document.querySelectorAll('.option-input');
    opts.forEach(input => input.value = '');
  }

  function showOptionFields() {
    const type = document.getElementById('questionType').value;
    document.getElementById('openAnswer').style.display = (type === 'open') ? 'block' : 'none';
    document.getElementById('yesNoAnswer').style.display = (type === 'yesno') ? 'block' : 'none';
    document.getElementById('multipleOptions').style.display = (type === 'multiple') ? 'block' : 'none';
  }

  function addNewCategory() {
    const input = document.getElementById('newCategoryInput');
    const newCat = input.value.trim();
    if(newCat === '') {
      alert('Please enter a category name.');
      input.focus();
      return;
    }
    if (categories.includes(newCat)) {
      alert('Category already exists.');
      input.focus();
      return;
    }
    categories.push(newCat);
    categories.sort();
    populateCategorySelect();
    populateManageCategoryFilter();
    const select = document.getElementById('categorySelect');
    select.value = newCat;
    hideNewCategoryInputArea();
  }

  function addQuestion() {
    let dt = document.getElementById('newDateTime').value;
    let questionText = document.getElementById('newQuestion').value.trim();
    let description = document.getElementById('newDescription').value.trim();
    let sideDescription = document.getElementById('newSideDescription').value.trim();

    let category;
    if(document.getElementById('newCategoryInputArea').style.display === 'flex') {
      category = document.getElementById('newCategoryInput').value.trim();
      if (!category) {
        alert("Please enter a category name or cancel.");
        return;
      }
    } else {
      let select = document.getElementById('categorySelect');
      category = select.value || 'Uncategorized';
    }

    let type = document.getElementById('questionType').value;

    if (!dt || !questionText) {
      alert("Please enter date/time and query text.");
      return;
    }
    if (!category) {
      alert("Please enter a category or fill it with 'Uncategorized'.");
      return;
    }

    if(!categories.includes(category)) {
      categories.push(category);
      categories.sort();
    }

    let correctAnswer;
    let options = [];

    if (type === 'open') {
      correctAnswer = document.getElementById('newAnswerOpen').value.trim();
      if (!correctAnswer) {
        alert("Please enter the correct answer.");
        return;
      }
    } else if (type === 'yesno') {
      let boxes = document.getElementsByName('yesnoAdd');
      correctAnswer = null;
      for (let i = 0; i < boxes.length; i++) {
        if (boxes[i].checked) {
          correctAnswer = boxes[i].value;
          break;
        }
      }
      if (!correctAnswer) {
        alert("Please select the correct answer (Yes or No).");
        return;
      }
    } else if (type === 'multiple') {
      const optionInputs = document.querySelectorAll('.option-input');
      options = [];
      optionInputs.forEach(inp => {
        if (inp.value.trim()) {
          options.push(inp.value.trim());
        }
      });
      if (options.length < 2) {
        alert("Please enter at least two options.");
        return;
      }
      correctAnswer = document.getElementById('newAnswer').value.trim();
      if (!correctAnswer) {
        alert("Please enter the correct answer.");
        return;
      }
      if (!options.includes(correctAnswer)) {
        alert("Correct answer must match one of the options.");
        return;
      }
    }

    const editIndex = getEditIndex();
    if (editIndex !== null) {
      // Update existing query
      questions[editIndex] = {
        datetime: dt,
        question: questionText,
        description: description,
        sideDescription: sideDescription,
        category: category,
        type: type,
        options: options,
        correctAnswer: correctAnswer
      };
    } else {
      // Add new query
      questions.push({
        datetime: dt,
        question: questionText,
        description: description,
        sideDescription: sideDescription,
        category: category,
        type: type,
        options: options,
        correctAnswer: correctAnswer
      });
    }

    saveQuestionsToStorage();
    initCategories();

    alert("Query " + (editIndex !== null ? "updated" : "added") + "!");
    closeQuestionPopup();
  }

  function getEditIndex() {
    const val = document.getElementById('questionPopup').getAttribute('data-edit-index');
    if(val === '' || val === null) return null;
    const parsed = parseInt(val, 10);
    if(isNaN(parsed)) return null;
    return parsed;
  }
  function setEditIndex(index) {
    document.getElementById('questionPopup').setAttribute('data-edit-index', index);
    const btn = document.getElementById('addUpdateQuestionBtn');
    if(index !== null && index !== undefined) {
      btn.textContent = 'Update Query';
      document.getElementById('popupTitle').textContent = 'Edit Settlement Query';
    } else {
      btn.textContent = 'Add Query';
      document.getElementById('popupTitle').textContent = 'Add Settlement Query';
    }
  }
  function clearEditMode() {
    setEditIndex(null);
  }

  function editQuery(index) {
    const query = questions[index];
    if(!query) return;
    // Populate fields
    document.getElementById('newDateTime').value = query.datetime;
    document.getElementById('newQuestion').value = query.question;
    document.getElementById('newDescription').value = query.description;
    document.getElementById('newSideDescription').value = query.sideDescription;

    if(!categories.includes(query.category) && query.category) {
      categories.push(query.category);
      categories.sort();
      populateCategorySelect();
      populateManageCategoryFilter();
    }
    document.getElementById('categorySelect').value = query.category || '';

    document.getElementById('questionType').value = query.type;
    showOptionFields();

    if (query.type === 'open') {
      document.getElementById('newAnswerOpen').value = query.correctAnswer;
    } else if (query.type === 'yesno') {
      const boxes = document.getElementsByName('yesnoAdd');
      boxes.forEach(box => {
        box.checked = (box.value === query.correctAnswer);
      });
    } else if (query.type === 'multiple') {
      const optionInputs = document.querySelectorAll('.option-input');
      optionInputs.forEach((input, idx) => {
        input.value = query.options[idx] || '';
      });
      document.getElementById('newAnswer').value = query.correctAnswer;
    }

    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('questionPopup').style.display = 'block';
    setEditIndex(index);
    document.getElementById('questionPopup').focus();
  }

  // Modified to save questions to server via POST API call
  function saveQuestionsToStorage() {
    fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(questions)
    }).then(response => {
      if (!response.ok) throw new Error(`Failed to save questions: ${response.statusText}`);
      // optionally: console.log('Questions saved to server');
    }).catch(err => {
      console.error(err);
      alert('Error saving queries online. Please check your connection or server.');
    });
  }

  // Modified to load questions from server via GET API call
  function loadQuestionsFromStorage() {
    fetch(API_ENDPOINT)
      .then(response => {
        if (!response.ok) throw new Error(`Failed to load questions: ${response.statusText}`);
        return response.json();
      })
      .then(data => {
        if(Array.isArray(data)) {
          questions = data;
        } else {
          questions = [];
        }
        initCategories();
      })
      .catch(err => {
        console.error(err);
        alert('Error loading queries online. Falling back to empty data.');
        questions = [];
        initCategories();
      });
  }

  function showCategorySelector() {
    populateCategoryOptions();
    document.getElementById('categorySelectOverlay').style.display = 'flex';
    document.getElementById('quizCategorySelect').focus();
  }

  function closeCategorySelector() {
    document.getElementById('categorySelectOverlay').style.display = 'none';
  }

  function showDifficultySelector() {
    const select = document.getElementById('quizCategorySelect');
    const selectedCat = select.value;
    if(!selectedCat) {
      alert('Please select a category.');
      select.focus();
      return;
    }
    chosenCategory = selectedCat;
    closeCategorySelector();
    document.getElementById('difficultySelectOverlay').style.display = 'flex';
    const diffSelect = document.getElementById('quizDifficultySelect');
    const countSelect = document.getElementById('queryCountSelect');
    diffSelect.value = chosenDifficulty || 'easy';
    countSelect.value = chosenNumQueries || '10';
    diffSelect.focus();
  }

  function closeDifficultySelector() {
    document.getElementById('difficultySelectOverlay').style.display = 'none';
  }

  // Other quiz functions left unchanged for brevity...

  // Remaining code from your original script can remain unchanged - quiz flow, export, manage queries, etc.

  // The rest of your JavaScript is unchanged and works as before.

  // To keep answer concise, other functions are assumed same as original, only localStorage replaced with fetch API calls.

  /* ...Your original quiz, timer, checkAnswer, feedback, showSummary, export, manage queries functions remain... */

  // For brevity, the rest is same as original and can be inserted to complete functionality as needed.

  // The key modification is replacing the localStorage usage with fetch calls to your server API endpoint.

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('addCategoryBtn').addEventListener('click', showNewCategoryInputArea);
    document.getElementById('cancelNewCategoryBtn').addEventListener('click', hideNewCategoryInputArea);
    document.getElementById('confirmNewCategoryBtn').addEventListener('click', addNewCategory);
    document.getElementById('newCategoryInput').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') {
        e.preventDefault();
        addNewCategory();
      }
    });
  });
</script>
</body>
</html>

