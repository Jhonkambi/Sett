<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Settlement Training</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f9f9f9;
    color: #222;
  }
  header {
    background: #003366;
    color: white;
    padding: 15px 20px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
  }
  #homeScreen, #questionPopup, #quizArea, #summary, #difficultySelectOverlay, #categorySelectOverlay, #manageQueriesOverlay {
    max-width: 700px;
    margin: 20px auto;
    background: white;
    padding: 15px 20px;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  #homeScreen {
    text-align: center;
  }
  button {
    margin: 10px 10px 10px 0;
    padding: 10px 20px;
    background: #003366;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 15px;
  }
  button:hover {
    background: #002244;
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
    font-size: 14px;
  }
  select, input[type=text], input[type=datetime-local], textarea {
    width: 100%;
    padding: 7px 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 3px;
    box-sizing: border-box;
  }
  /* Adjust width of Settlement Query input to be slightly wider than Date & Time input */
  #newQuestion {
    width: calc(100% + 20px);
  }
  textarea {
    resize: vertical;
  }
  .checkbox-label {
    display: flex;
    align-items: center;
    margin: 5px 0;
    font-weight: normal;
    cursor: pointer;
  }
  .checkbox-label input {
    margin-right: 8px;
  }
  #quizQuestionArea {
    display: flex;
    gap: 20px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  #questionMain {
    flex: 1 1 100%;
    display: flex;
    flex-direction: row;
    gap: 15px;
    align-items: center; /* vertical center alignment */
    min-width: 280px;
  }
  #questionDate {
    font-size: 14px; /* slightly larger for better balance */
    color: black;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
    line-height: 1.3;
    /* align self center to ensure vertical alignment */
    align-self: center;
  }
  #quizQuestion {
    font-size: 16px; /* slightly reduced from 16 to 15 to better align */
    font-weight: 600;
    flex-grow: 1;
    white-space: normal;
    overflow-wrap: break-word;
    line-height: 1.3;
    display: flex;
    align-items: center; /* vertical align text */
  }
  #questionDescription {
    font-size: 14px;
    margin-top: 10px;
    color: #444;
    white-space: normal;
    overflow-wrap: break-word;
    flex-basis: 100%;
  }
  /* quiz input layout */
  #quizInputArea {
    margin-top: 10px;
  }
  #quizInputControls {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  /* New container to hold submit button and side description on the same row */
  #submitAndSideDescContainer {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-top: 5px;
  }
  #questionSideDescription {
    font-size: 14px;
    color: #333;
    font-style: italic;
    white-space: normal;
    max-width: 300px;
    max-height: 100px;
    overflow-y: auto;
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
  }
  #timer {
    font-weight: bold;
    font-size: 15px;
    margin-bottom: 12px;
    color: #003366;
  }
  #feedback {
    font-weight: bold;
    margin-top: 10px;
    min-height: 22px;
  }
  #difficultySelectOverlay, #categorySelectOverlay, #manageQueriesOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #difficultySelectOverlay > div, #categorySelectOverlay > div, #manageQueriesOverlay > div {
    background: white;
    padding: 20px 25px;
    border-radius: 6px;
    width: 320px;
    box-sizing: border-box;
    text-align: center;
    max-height: 80vh;
    overflow-y: auto;
  }
  #difficultySelectOverlay label, #categorySelectOverlay label, #manageQueriesOverlay label {
    font-weight: normal;
    margin: 10px 0;
    font-size: 16px;
    cursor: pointer;
    display: block;
  }
  #difficultySelectOverlay input[type=radio],
  #categorySelectOverlay input[type=radio] {
    margin-right: 8px;
    cursor: pointer;
  }
  #questionPopup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 600px;
    width: 90%;
    z-index: 1100;
  }
  #popupOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1050;
  }
  /* Manage Queries List Styling */
  #manageFilterArea {
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  #manageFilterArea select {
    flex: 1;
  }
  #manageQueriesList {
    text-align: left;
    max-height: 50vh;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  .query-item {
    border-bottom: 1px solid #ccc;
    padding: 6px 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .query-question {
    font-weight: 600;
    font-size: 14px;
    color: #222;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }
  .query-date {
    font-size: 12px;
    color: #666;
    margin-left: 8px;
    white-space: nowrap;
  }
  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    gap: 10px;
  }
  .remove-query-btn {
    background: #c00;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    padding: 5px 10px;
    font-size: 13px;
  }
  .remove-query-btn:hover {
    background: #900;
  }
  button.edit-btn {
    background: #0066cc;
    font-weight: bold;
    color: #fff;
    border-radius: 4px;
    padding: 5px 12px;
    margin-left: 12px;
    cursor: pointer;
    font-size: 13px;
    border: none;
    flex-shrink: 0;
  }
  button.edit-btn:hover {
    background: #004a99;
  }
  /* Summary improvements */
  #summary h3 {
    margin-top: 0;
  }
  #incorrectList {
    text-align: left;
    margin-top: 15px;
  }
  .incorrect-item {
    background: #ffe5e5;
    border: 1px solid #c00;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .incorrect-question {
    font-weight: 700;
    margin-bottom: 5px;
    color: #900;
  }
  .incorrect-user-answer {
    margin-left: 10px;
    font-style: italic;
    color: #333;
  }
  .incorrect-correct-answer {
    margin-left: 10px;
    font-weight: 600;
    color: #006600;
  }
  .timedout-question {
    margin-left: 10px;
    font-style: italic;
    color: #aa5500;
    font-weight: 600;
  }
  @media (max-width: 480px) {
    #quizQuestionArea {
      flex-direction: column;
    }
    #questionMain {
      flex-direction: column;
      gap: 5px;
      align-items: flex-start;
    }
    #submitAndSideDescContainer {
      flex-direction: column;
      align-items: flex-start;
    }
    #questionSideDescription {
      max-width: 100%;
      max-height: none;
      padding-top: 8px;
      margin-left: 0;
    }
    button {
      width: 100%;
      margin: 10px 0;
    }
    #manageFilterArea {
      flex-direction: column;
      gap: 6px;
    }
  }
</style>
</head>
<body>

<header>Settlement Training</header>

<div id="homeScreen">
  <button onclick="showQuestionPopup()">Add Queries</button>
  <button onclick="showCategorySelector()">Start Quiz</button>
  <button onclick="showManageQueries()">Manage Queries</button>
</div>

<div id="popupOverlay" onclick="closeQuestionPopup()"></div>

<!-- Add Query Popup -->
<div id="questionPopup">
  <h3 id="popupTitle">Add Settlement Query</h3>
  <label for="newDateTime">Date & Time:</label>
  <input type="datetime-local" id="newDateTime" />

  <label for="newQuestion">Settlement Query:</label>
  <input type="text" id="newQuestion" placeholder="Enter your query here..." />

  <label for="newDescription">Description:</label>
  <textarea id="newDescription" rows="3" placeholder="Additional details..."></textarea>

  <label for="newSideDescription">Optional Side Description:</label>
  <textarea id="newSideDescription" rows="2" placeholder="Optional description to show on quiz right side..."></textarea>

  <label for="categorySelect">Category:</label>
  <div style="display: flex; align-items: center; gap: 8px;">
    <select id="categorySelect" style="flex: 1;"></select>
    <button type="button" id="addCategoryBtn" style="background:#006600; font-weight:bold; color:#fff; border-radius:4px; padding: 5px 10px; cursor: pointer;">+</button>
  </div>
  <div id="newCategoryInputArea" style="display:none; margin-top:8px; gap: 8px; align-items: center;">
    <input type="text" id="newCategoryInput" placeholder="Enter new category" style="flex: 1; padding: 6px 10px; font-size: 14px;"/>
    <button type="button" id="confirmNewCategoryBtn" style="background:#004400; font-weight:bold; color:#fff; border-radius:4px; padding: 6px 10px; cursor:pointer;">Add</button>
    <button type="button" id="cancelNewCategoryBtn" style="background:#c00; font-weight:bold; color:#fff; border-radius:4px; padding: 6px 10px; cursor:pointer;">Cancel</button>
  </div>

  <label for="questionType">Query Type:</label>
  <select id="questionType" onchange="showOptionFields()">
    <option value="open">Open Ended</option>
    <option value="yesno">Tick Box (Yes / No / Void)</option>
    <option value="multiple">Multiple Choice (tick one)</option>
  </select>

  <div id="openAnswer" style="display:block; margin-top:10px;">
    <label for="newAnswerOpen">Correct Answer:</label>
    <input type="text" id="newAnswerOpen" placeholder="Correct answer text" />
  </div>

  <div id="yesNoAnswer" style="display:none; margin-top:10px;">
    <label>Correct Answer:</label>
    <label class="checkbox-label">
      <input type="checkbox" name="yesnoAdd" value="Yes" /> Yes
    </label>
    <label class="checkbox-label">
      <input type="checkbox" name="yesnoAdd" value="No" /> No
    </label>
    <label class="checkbox-label">
      <input type="checkbox" name="yesnoAdd" value="Void" /> Void
    </label>
  </div>

  <div id="multipleOptions" style="display:none; margin-top:10px;">
    <label>Options (enter at least 2):</label>
    <input type="text" class="option-input" placeholder="Option 1" />
    <input type="text" class="option-input" placeholder="Option 2" />
    <input type="text" class="option-input" placeholder="Option 3 (optional)" />
    <input type="text" class="option-input" placeholder="Option 4 (optional)" />

    <label for="newAnswer" style="margin-top:8px;">Correct Answer (must match one option):</label>
    <input type="text" id="newAnswer" placeholder="Correct answer" />
  </div>

  <button id="addUpdateQuestionBtn" onclick="addQuestion()">Add Query</button>
  <button onclick="closeQuestionPopup()" style="background:#c00; margin-left: 10px;">Cancel</button>
</div>

<!-- Category Selector Overlay (dropdown for categories) -->
<div id="categorySelectOverlay">
  <div>
    <h3>Select Category</h3>
    <label for="quizCategorySelect">Choose category:</label>
    <select id="quizCategorySelect" style="width: 100%; padding: 8px; font-size: 16px; margin-bottom: 15px;">
      <!-- options dynamically populated -->
    </select>
    <button onclick="showDifficultySelector()" style="margin-top:15px;">Next: Select Difficulty</button>
    <button onclick="closeCategorySelector()" style="margin-top:10px; background:#c00;">Cancel</button>
  </div>
</div>

<!-- Difficulty Selector Overlay -->
<div id="difficultySelectOverlay">
  <div>
    <h3>Select Difficulty & Number of Queries</h3>
    <label for="quizDifficultySelect">Choose difficulty:</label>
    <select id="quizDifficultySelect" style="width: 100%; padding: 8px; font-size: 16px; margin-bottom: 15px;">
      <option value="easy">Easy (2 min per query)</option>
      <option value="medium">Medium (1 min per query)</option>
      <option value="hard">Hard (30 sec per query)</option>
      <option value="insane">Insane (15 sec per query)</option>
      <option value="peaceful">Peaceful (No time limit)</option>
    </select>

    <label for="queryCountSelect">Number of Queries:</label>
    <select id="queryCountSelect" style="width: 100%; padding: 8px; font-size: 16px; margin-bottom: 15px;">
      <option value="10">10 Queries</option>
      <option value="20">20 Queries</option>
      <option value="30">30 Queries</option>
      <option value="40">40 Queries</option>
      <option value="50">50 Queries</option>
      <option value="60">60 Queries</option>
    </select>

    <button onclick="startQuiz()" style="margin-top:15px;">Start</button>
    <button onclick="closeDifficultySelector()" style="margin-top:10px; background:#c00;">Cancel</button>
  </div>
</div>

<!-- Manage Queries Overlay -->
<div id="manageQueriesOverlay">
  <div>
    <h3>Manage Queries</h3>
    <div id="manageFilterArea">
      <select id="manageCategoryFilter" onchange="filterManageQueries()">
        <!-- dynamically populated -->
      </select>
      <button style="background:#c00;" onclick="removeSelectedCategory()" title="Remove selected category if empty">Remove Category</button>
    </div>
    <div id="manageQueriesList">
    </div>
    <label class="checkbox-label" style="margin-top: 8px;">
      <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)" /> Select All
    </label>
    <button onclick="removeSelectedQueries()" style="margin-top:15px; background:#c00;">Remove Selected Queries</button>
    <button onclick="closeManageQueries()" style="margin-top:15px; background:#c00;">Close</button>
  </div>
</div>

<div id="quizArea" style="display:none;">
  <div id="timer"></div>
  <div id="quizQuestionArea">
    <div id="questionMain">
      <div id="questionDate"></div>
      <div id="quizQuestion"></div>
    </div>
    <div id="questionDescription"></div>
  </div>
  <div id="quizInputArea">
    <div id="quizInputControls"></div>
  </div>
  <div id="feedback"></div>
</div>

<div id="summary" style="display:none;"></div>

<!-- SheetJS library for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // Data and state
  let questions = [];
  let filteredQuestions = [];
  let categories = [];
  let timerInterval;
  let timeLeft = 0;
  let currentIndex = 0;
  let correctAnswers = 0;
  let timedOutCount = 0;
  let answeredCount = 0;
  let chosenDifficulty = 'easy';
  let chosenCategory = 'All Categories';
  let chosenNumQueries = 10;

  let userResponses = [];
  let startTime;
  let totalTimeTaken = 0;

  const difficultyTimes = {
    easy: 120,
    medium: 60,
    hard: 30,
    insane: 15,
    peaceful: null
  };

  loadQuestionsFromStorage();
  initCategories();

  function initCategories() {
    const catSet = new Set();
    questions.forEach(q => {
      if(q.category && q.category.trim() !== '') {
        catSet.add(q.category.trim());
      }
    });
    categories = Array.from(catSet).sort();
    if(categories.length === 0) {
      categories.push('Uncategorized');
    }
    populateCategorySelect();
    populateManageCategoryFilter();
  }

  function populateCategorySelect() {
    const select = document.getElementById('categorySelect');
    select.innerHTML = '';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
    if(!select.value && categories.length) {
      select.value = categories[0];
    }
    hideNewCategoryInputArea();
  }

  function populateManageCategoryFilter() {
    const filter = document.getElementById('manageCategoryFilter');
    filter.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'All Categories';
    optAll.textContent = 'All Categories';
    filter.appendChild(optAll);
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      filter.appendChild(option);
    });
    filter.value = 'All Categories';
  }

  // Populate dropdown in categorySelectOverlay
  function populateCategoryOptions() {
    const select = document.getElementById('quizCategorySelect');
    select.innerHTML = '';

    const optAll = document.createElement('option');
    optAll.value = 'All Categories';
    optAll.textContent = 'All Categories';
    select.appendChild(optAll);

    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
    select.value = 'All Categories';
  }

  function filterManageQueries() {
    renderManageQueriesList();
  }

  function showNewCategoryInputArea() {
    document.getElementById('newCategoryInputArea').style.display = 'flex';
    document.getElementById('categorySelect').style.display = 'none';
    document.getElementById('addCategoryBtn').style.display = 'none';
    document.getElementById('newCategoryInput').value = '';
    document.getElementById('newCategoryInput').focus();
  }

  function hideNewCategoryInputArea() {
    document.getElementById('newCategoryInputArea').style.display = 'none';
    document.getElementById('categorySelect').style.display = 'block';
    document.getElementById('addCategoryBtn').style.display = 'inline-block';
  }

  function showQuestionPopup() {
    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('questionPopup').style.display = 'block';
    resetAddQueryFields();
    initCategories();
    clearEditMode();
  }

  function closeQuestionPopup() {
    document.getElementById('popupOverlay').style.display = 'none';
    document.getElementById('questionPopup').style.display = 'none';
    clearEditMode();
  }

  function resetAddQueryFields() {
    document.getElementById('newDateTime').value = '';
    document.getElementById('newQuestion').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newSideDescription').value = '';
    document.getElementById('questionType').value = 'open';
    showOptionFields();
    document.getElementById('newAnswerOpen').value = '';
    document.getElementById('newAnswer').value = '';
    hideNewCategoryInputArea();
    let yesNoBoxes = document.getElementsByName('yesnoAdd');
    for (let i = 0; i < yesNoBoxes.length; i++) {
      yesNoBoxes[i].checked = false;
    }
    let opts = document.querySelectorAll('.option-input');
    opts.forEach(input => input.value = '');
  }

  function showOptionFields() {
    const type = document.getElementById('questionType').value;
    document.getElementById('openAnswer').style.display = (type === 'open') ? 'block' : 'none';
    document.getElementById('yesNoAnswer').style.display = (type === 'yesno') ? 'block' : 'none';
    document.getElementById('multipleOptions').style.display = (type === 'multiple') ? 'block' : 'none';
  }

  function addNewCategory() {
    const input = document.getElementById('newCategoryInput');
    const newCat = input.value.trim();
    if(newCat === '') {
      alert('Please enter a category name.');
      input.focus();
      return;
    }
    if (categories.includes(newCat)) {
      alert('Category already exists.');
      input.focus();
      return;
    }
    categories.push(newCat);
    categories.sort();
    populateCategorySelect();
    populateManageCategoryFilter();
    const select = document.getElementById('categorySelect');
    select.value = newCat;
    hideNewCategoryInputArea();
  }

  function addQuestion() {
    let dt = document.getElementById('newDateTime').value;
    let questionText = document.getElementById('newQuestion').value.trim();
    let description = document.getElementById('newDescription').value.trim();
    let sideDescription = document.getElementById('newSideDescription').value.trim();

    let category;
    if(document.getElementById('newCategoryInputArea').style.display === 'flex') {
      category = document.getElementById('newCategoryInput').value.trim();
      if (!category) {
        alert("Please enter a category name or cancel.");
        return;
      }
    } else {
      let select = document.getElementById('categorySelect');
      category = select.value || 'Uncategorized';
    }

    let type = document.getElementById('questionType').value;

    if (!dt || !questionText) {
      alert("Please enter date/time and query text.");
      return;
    }
    if (!category) {
      alert("Please enter a category or fill it with 'Uncategorized'.");
      return;
    }

    if(!categories.includes(category)) {
      categories.push(category);
      categories.sort();
    }

    let correctAnswer;
    let options = [];

    if (type === 'open') {
      correctAnswer = document.getElementById('newAnswerOpen').value.trim();
      if (!correctAnswer) {
        alert("Please enter the correct answer.");
        return;
      }
    } else if (type === 'yesno') {
      let boxes = document.getElementsByName('yesnoAdd');
      correctAnswer = null;
      for (let i = 0; i < boxes.length; i++) {
        if (boxes[i].checked) {
          correctAnswer = boxes[i].value;
          break;
        }
      }
      if (!correctAnswer) {
        alert("Please select the correct answer (Yes, No, or Void).");
        return;
      }
    } else if (type === 'multiple') {
      const optionInputs = document.querySelectorAll('.option-input');
      options = [];
      optionInputs.forEach(inp => {
        if (inp.value.trim()) {
          options.push(inp.value.trim());
        }
      });
      if (options.length < 2) {
        alert("Please enter at least two options.");
        return;
      }
      correctAnswer = document.getElementById('newAnswer').value.trim();
      if (!correctAnswer) {
        alert("Please enter the correct answer.");
        return;
      }
      if (!options.includes(correctAnswer)) {
        alert("Correct answer must match one of the options.");
        return;
      }
    }

    const editIndex = getEditIndex();
    if (editIndex !== null) {
      // Update existing query
      questions[editIndex] = {
        datetime: dt,
        question: questionText,
        description: description,
        sideDescription: sideDescription,
        category: category,
        type: type,
        options: options,
        correctAnswer: correctAnswer
      };
    } else {
      // Add new query
      questions.push({
        datetime: dt,
        question: questionText,
        description: description,
        sideDescription: sideDescription,
        category: category,
        type: type,
        options: options,
        correctAnswer: correctAnswer
      });
    }

    saveQuestionsToStorage();
    initCategories();

    alert("Query " + (editIndex !== null ? "updated" : "added") + "!");
    closeQuestionPopup();
  }

  function getEditIndex() {
    const val = document.getElementById('questionPopup').getAttribute('data-edit-index');
    if(val === '' || val === null) return null;
    const parsed = parseInt(val, 10);
    if(isNaN(parsed)) return null;
    return parsed;
  }
  function setEditIndex(index) {
    document.getElementById('questionPopup').setAttribute('data-edit-index', index);
    const btn = document.getElementById('addUpdateQuestionBtn');
    if(index !== null && index !== undefined) {
      btn.textContent = 'Update Query';
      document.getElementById('popupTitle').textContent = 'Edit Settlement Query';
    } else {
      btn.textContent = 'Add Query';
      document.getElementById('popupTitle').textContent = 'Add Settlement Query';
    }
  }
  function clearEditMode() {
    setEditIndex(null);
  }

  function editQuery(index) {
    const query = questions[index];
    if(!query) return;
    // Populate fields
    document.getElementById('newDateTime').value = query.datetime;
    document.getElementById('newQuestion').value = query.question;
    document.getElementById('newDescription').value = query.description;
    document.getElementById('newSideDescription').value = query.sideDescription;

    // Check if category exists, if not add temporarily
    if(!categories.includes(query.category) && query.category) {
      categories.push(query.category);
      categories.sort();
      populateCategorySelect();
      populateManageCategoryFilter();
    }
    document.getElementById('categorySelect').value = query.category || '';

    document.getElementById('questionType').value = query.type;
    showOptionFields();

    if (query.type === 'open') {
      document.getElementById('newAnswerOpen').value = query.correctAnswer;
    } else if (query.type === 'yesno') {
      const boxes = document.getElementsByName('yesnoAdd');
      boxes.forEach(box => {
        box.checked = (box.value === query.correctAnswer);
      });
    } else if (query.type === 'multiple') {
      const optionInputs = document.querySelectorAll('.option-input');
      optionInputs.forEach((input, idx) => {
        input.value = query.options[idx] || '';
      });
      document.getElementById('newAnswer').value = query.correctAnswer;
    }

    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('questionPopup').style.display = 'block';
    setEditIndex(index);
  }

  function saveQuestionsToStorage() {
    localStorage.setItem('settlementQueries', JSON.stringify(questions));
  }

  function loadQuestionsFromStorage() {
    const saved = localStorage.getItem('settlementQueries');
    if(saved) {
      questions = JSON.parse(saved);
    }
  }

  function showCategorySelector() {
    populateCategoryOptions();
    document.getElementById('categorySelectOverlay').style.display = 'flex';
  }

  function closeCategorySelector() {
    document.getElementById('categorySelectOverlay').style.display = 'none';
  }

  function showDifficultySelector() {
    const select = document.getElementById('quizCategorySelect');
    const selectedCat = select.value;
    if(!selectedCat) {
      alert('Please select a category.');
      return;
    }
    chosenCategory = selectedCat;
    closeCategorySelector();
    document.getElementById('difficultySelectOverlay').style.display = 'flex';
    // Set defaults for difficulty and query count dropdowns when opening
    const diffSelect = document.getElementById('quizDifficultySelect');
    const countSelect = document.getElementById('queryCountSelect');
    diffSelect.value = chosenDifficulty || 'easy';
    countSelect.value = chosenNumQueries || '10';
  }

  function closeDifficultySelector() {
    document.getElementById('difficultySelectOverlay').style.display = 'none';
  }

  function startQuiz() {
    const difficultySelect = document.getElementById('quizDifficultySelect');
    const selectedDiff = difficultySelect.value;
    if(!selectedDiff) {
      alert('Please select a difficulty.');
      return;
    }
    chosenDifficulty = selectedDiff;

    const queryCountSelect = document.getElementById('queryCountSelect');
    const selectedQueryCount = parseInt(queryCountSelect.value, 10);
    if(!selectedQueryCount || selectedQueryCount <= 0) {
      alert('Please select a valid number of queries.');
      return;
    }
    chosenNumQueries = selectedQueryCount;

    closeDifficultySelector();

    if(chosenCategory === 'All Categories') {
      filteredQuestions = questions.slice();
    } else {
      filteredQuestions = questions.filter(q => q.category === chosenCategory);
    }

    if(filteredQuestions.length === 0) {
      alert('No queries available for the selected category.');
      return;
    }

    // Limit questions count
    if (filteredQuestions.length > chosenNumQueries) {
      filteredQuestions = filteredQuestions.slice(0, chosenNumQueries);
    }

    currentIndex = 0;
    correctAnswers = 0;
    timedOutCount = 0;
    answeredCount = 0;
    userResponses = [];
    startTime = new Date();

    document.getElementById('homeScreen').style.display = 'none';
    document.getElementById('summary').style.display = 'none';
    document.getElementById('quizArea').style.display = 'block';

    showNextQuestion();
  }

  function showNextQuestion() {
    clearInterval(timerInterval);
    timeLeft = difficultyTimes[chosenDifficulty];
    if (timeLeft !== null) {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if(timeLeft <= 0) {
          clearInterval(timerInterval);
          feedback('Time is up!', false);
          timedOutCount++;
          answeredCount++;
          userResponses.push({question: filteredQuestions[currentIndex].question, correctAnswer: filteredQuestions[currentIndex].correctAnswer, userAnswer: null, timedOut: true});
          currentIndex++;
          setTimeout(() => {
            if(currentIndex < filteredQuestions.length) {
              showNextQuestion();
            } else {
              showSummary();
            }
          }, 1500);
        }
      }, 1000);
    } else {
      document.getElementById('timer').textContent = '';
    }

    const q = filteredQuestions[currentIndex];
    document.getElementById('questionDate').textContent = new Date(q.datetime).toLocaleString();
    document.getElementById('quizQuestion').textContent = q.question;
    document.getElementById('questionDescription').textContent = q.description || '';

    document.getElementById('feedback').textContent = '';

    const quizInputArea = document.getElementById('quizInputArea');
    quizInputArea.innerHTML = '';

    const inputControlsDiv = document.createElement('div');
    inputControlsDiv.id = 'quizInputControls';

    const submitAndSideDescDiv = document.createElement('div');
    submitAndSideDescDiv.id = 'submitAndSideDescContainer';

    const sideDescDiv = document.createElement('div');
    sideDescDiv.id = 'questionSideDescription';

    if(q.sideDescription && q.sideDescription.trim() !== '') {
      sideDescDiv.style.display = 'block';
      sideDescDiv.textContent = q.sideDescription.trim();
    } else {
      sideDescDiv.style.display = 'none';
      sideDescDiv.textContent = '';
    }

    if(q.type === 'open') {
      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'answerInput';
      input.placeholder = 'Your answer...';
      inputControlsDiv.appendChild(input);

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Submit Answer';
      submitBtn.onclick = checkAnswer;

      submitAndSideDescDiv.appendChild(submitBtn);
      submitAndSideDescDiv.appendChild(sideDescDiv);

      inputControlsDiv.appendChild(submitAndSideDescDiv);

    } else if(q.type === 'yesno') {
      ['Yes', 'No', 'Void'].forEach(opt => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'yesnoAnswer';
        checkbox.value = opt;
        checkbox.addEventListener('change', (event) => {
          if(event.target.checked) {
            const others = document.getElementsByName('yesnoAnswer');
            others.forEach(cb => {
              if(cb !== event.target) cb.checked = false;
            });
          }
        });

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(opt));
        inputControlsDiv.appendChild(label);
      });

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Submit Answer';
      submitBtn.onclick = checkAnswer;

      submitAndSideDescDiv.appendChild(submitBtn);
      submitAndSideDescDiv.appendChild(sideDescDiv);

      inputControlsDiv.appendChild(submitAndSideDescDiv);

    } else if(q.type === 'multiple') {
      q.options.forEach(opt => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'multipleAnswer';
        checkbox.value = opt;
        checkbox.addEventListener('change', (event) => {
          if(event.target.checked) {
            const others = document.getElementsByName('multipleAnswer');
            others.forEach(cb => {
              if(cb !== event.target) cb.checked = false;
            });
          }
        });

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(opt));
        inputControlsDiv.appendChild(label);
      });

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Submit Answer';
      submitBtn.onclick = checkAnswer;

      submitAndSideDescDiv.appendChild(submitBtn);
      submitAndSideDescDiv.appendChild(sideDescDiv);

      inputControlsDiv.appendChild(submitAndSideDescDiv);
    }

    quizInputArea.appendChild(inputControlsDiv);
  }

  function updateTimerDisplay() {
    document.getElementById('timer').textContent = `Time Left: ${timeLeft} sec`;
  }

  function checkAnswer() {
    clearInterval(timerInterval);
    const q = filteredQuestions[currentIndex];
    let userAnswer = null;

    if(q.type === 'open') {
      userAnswer = document.getElementById('answerInput').value.trim();
    } else if(q.type === 'yesno') {
      const checkboxes = document.getElementsByName('yesnoAnswer');
      for(let cb of checkboxes) {
        if(cb.checked) {
          userAnswer = cb.value;
          break;
        }
      }
    } else if(q.type === 'multiple') {
      const checkboxes = document.getElementsByName('multipleAnswer');
      for(let cb of checkboxes) {
        if(cb.checked) {
          userAnswer = cb.value;
          break;
        }
      }
    }

    if(userAnswer === null || userAnswer === '') {
      alert('Please select or enter an answer before submitting.');
      if (timeLeft !== null) {
        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          if(timeLeft <= 0) {
            clearInterval(timerInterval);
            feedback('Time is up!', false);
            timedOutCount++;
            answeredCount++;
            userResponses.push({question: q.question, correctAnswer: q.correctAnswer, userAnswer: null, timedOut: true});
            currentIndex++;
            setTimeout(() => {
              if(currentIndex < filteredQuestions.length) {
                showNextQuestion();
              } else {
                showSummary();
              }
            }, 1500);
          }
        }, 1000);
      }
      return;
    }

    const isCorrect = (userAnswer.toLowerCase() === q.correctAnswer.toLowerCase());

    if(isCorrect) {
      correctAnswers++;
    }
    answeredCount++;

    userResponses.push({question: q.question, correctAnswer: q.correctAnswer, userAnswer: userAnswer, timedOut: false});

    feedback(isCorrect ? 'Correct!' : 'Incorrect!', isCorrect);

    currentIndex++;
    setTimeout(() => {
      if(currentIndex < filteredQuestions.length) {
        showNextQuestion();
      } else {
        showSummary();
      }
    }, 1500);
  }

  function feedback(msg, isCorrect) {
    const fb = document.getElementById('feedback');
    fb.textContent = msg;
    fb.style.color = isCorrect ? 'green' : 'red';
  }

  function showSummary() {
    document.getElementById('quizArea').style.display = 'none';
    const summaryDiv = document.getElementById('summary');
    summaryDiv.style.display = 'block';

    totalTimeTaken = (new Date() - startTime) / 1000; // seconds
    const averageTimePerQuestion = answeredCount > 0 ? (totalTimeTaken / answeredCount).toFixed(2) : 0;
    const percentageCorrect = (correctAnswers / answeredCount * 100).toFixed(2);

    let html = `<h3>Quiz Summary</h3>`;
    html += `<p>Total Queries: ${filteredQuestions.length}</p>`;
    html += `<p>Answered: ${answeredCount}</p>`;
    html += `<p>Correct Answers: ${correctAnswers}</p>`;
    html += `<p>Timed Out: ${timedOutCount}</p>`;
    html += `<p>Total Time Taken: ${totalTimeTaken} seconds</p>`;
    html += `<p>Average Time per Question: ${averageTimePerQuestion} seconds</p>`;
    html += `<p>Percentage Correct: ${percentageCorrect}%</p>`;

    const incorrects = userResponses.filter(r => !r.timedOut && (!r.userAnswer || r.userAnswer.toLowerCase() !== r.correctAnswer.toLowerCase()));
    if(incorrects.length > 0) {
      html += `<div id="incorrectList"><h4>Incorrect Answers:</h4>`;
      incorrects.forEach(inc => {
        html += `<div class="incorrect-item">
          <div class="incorrect-question">${inc.question}</div>
          <div>Your Answer: <span class="incorrect-user-answer">${inc.userAnswer || 'No answer'}</span></div>
          <div>Correct Answer: <span class="incorrect-correct-answer">${inc.correctAnswer}</span></div>
        </div>`;
      });
      html += `</div>`;
    }

    const timedOuts = userResponses.filter(r => r.timedOut);
    if(timedOuts.length > 0) {
      html += `<div id="timedOutList"><h4>Timed Out Questions:</h4>`;
      timedOuts.forEach(toq => {
        html += `<div class="incorrect-item">
          <div class="incorrect-question timedout-question">${toq.question}</div>
          <div><em>You did not answer this query in time.</em></div>
          <div>Correct Answer: <span class="incorrect-correct-answer">${toq.correctAnswer}</span></div>
        </div>`;
      });
      html += `</div>`;
    }

    if(userResponses.length > 0) {
      html += `<button id="exportExcelBtn" style="margin-top:15px;">Export All Answers to Excel</button>`;
    }

    html += `<button onclick="returnToHome()" style="margin-top:15px;">Return Home</button>`;

    summaryDiv.innerHTML = html;

    // Add click listener to export button
    const btn = document.getElementById('exportExcelBtn');
    if(btn) {
      btn.addEventListener('click', exportAnswersExcel);
    }
  }

  function exportAnswersExcel() {
    if(userResponses.length === 0) {
      alert("No answers to export.");
      return;
    }

    const ws_data = [
      ["Question", "Your Answer", "Correct Answer", "Status"]
    ];

    userResponses.forEach(item => {
      const isCorrect = !item.timedOut && item.userAnswer && item.userAnswer.toLowerCase() === item.correctAnswer.toLowerCase();
      const statusText = item.timedOut ? "Timed Out" : (isCorrect ? "Correct" : "Incorrect");
      const userAnswerText = item.userAnswer || (item.timedOut ? "[Timed Out]" : "No answer");
      ws_data.push([item.question, userAnswerText, item.correctAnswer, statusText]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    XLSX.utils.book_append_sheet(wb, ws, "QuizResults");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }

    const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "quiz_results.xlsx";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
  }

  function returnToHome() {
    document.getElementById('summary').style.display = 'none';
    document.getElementById('homeScreen').style.display = 'block';
  }

  function showManageQueries() {
    document.getElementById('manageQueriesOverlay').style.display = 'flex';
    populateManageCategoryFilter();
    document.getElementById('manageCategoryFilter').value = 'All Categories';
    renderManageQueriesList();
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
  }

  function closeManageQueries() {
    document.getElementById('manageQueriesOverlay').style.display = 'none';
  }

  function renderManageQueriesList() {
    const listContainer = document.getElementById('manageQueriesList');
    listContainer.innerHTML = '';

    const selectedCategory = document.getElementById('manageCategoryFilter').value;

    let filteredList;
    if(selectedCategory === 'All Categories') {
      filteredList = questions;
    } else {
      filteredList = questions.filter(q => q.category === selectedCategory);
    }

    if(filteredList.length === 0) {
      listContainer.innerHTML = '<p>No queries found for this category.</p>';
      return;
    }

    filteredList.forEach((query, index) => {
      const originalIndex = questions.indexOf(query);
      const item = document.createElement('div');
      item.className = 'query-item';
      item.innerHTML = `
        <label class="checkbox-label" title="${query.question}">
          <input type="checkbox" class="query-checkbox" data-index="${originalIndex}" /> 
          <span class="query-question">${query.question}</span>
          <span class="query-date">${new Date(query.datetime).toLocaleString()}</span>
        </label>
        <button class="edit-btn" onclick="editQuery(${originalIndex})">Edit</button>
      `;
      listContainer.appendChild(item);
    });
  }

  function toggleSelectAll(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.query-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
  }

  function removeSelectedQueries() {
    const checkboxes = document.querySelectorAll('.query-checkbox:checked');
    if (checkboxes.length === 0) {
      alert('Please select at least one query to remove.');
      return;
    }

    if (confirm('Are you sure you want to remove the selected queries?')) {
      const indicesToRemove = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index'))).sort((a,b) => b - a);
      indicesToRemove.forEach(index => {
        questions.splice(index, 1);
      });
      saveQuestionsToStorage();
      initCategories();
      renderManageQueriesList();
      alert('Selected queries removed successfully.');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) selectAllCheckbox.checked = false;
    }
  }

  function removeSelectedCategory() {
    const filter = document.getElementById('manageCategoryFilter');
    const selectedCat = filter.value;
    if(selectedCat === 'All Categories') {
      alert('Cannot remove "All Categories"');
      return;
    }
    const hasQueries = questions.some(q => q.category === selectedCat);
    if(hasQueries) {
      alert('Cannot remove category that still contains queries. Remove queries first.');
      return;
    }
    const catIndex = categories.indexOf(selectedCat);
    if(catIndex !== -1) {
      if(confirm(`Are you sure you want to remove category "${selectedCat}"? This action cannot be undone.`)) {
        categories.splice(catIndex, 1);
        populateCategorySelect();
        populateManageCategoryFilter();
        alert(`Category "${selectedCat}" has been removed.`);
        renderManageQueriesList();
      }
    } else {
      alert('Category not found.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('addCategoryBtn').addEventListener('click', showNewCategoryInputArea);
    document.getElementById('cancelNewCategoryBtn').addEventListener('click', hideNewCategoryInputArea);
    document.getElementById('confirmNewCategoryBtn').addEventListener('click', addNewCategory);
    document.getElementById('newCategoryInput').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') {
        e.preventDefault();
        addNewCategory();
      }
    });
  });
</script>
</body>
</html>

